---
- hosts: all
  vars:
    cert_name: ace-web
    composer_path: /usr/local/bin/composer
    composer_path_dir: /usr/local/bin
    server_name: ace-web.vm
  tasks:
    - name: Add ppa repository for PHP
      apt_repository: repo=ppa:ondrej/php

    - name: Add ppa repository for nginx
      apt_repository: repo=ppa:nginx/development

    - name: Add source for NodeJS
      shell: 'curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -'
      args:
        warn: False

    - name: Install system packages
      apt: pkg={{ item }} state=latest update_cache=yes cache_valid_time=3600
      with_items:
        - acl
        - build-essential
        - curl
        - git
        - htop
        - imagemagick
        - libnotify-bin
        - python-software-properties
        - python-selinux
        - wget
        - vim

    - name: Install Ruby and related dev packages
      become: True
      apt: pkg={{ item }} state=latest update_cache=yes cache_valid_time=3600
      with_items:
        - ruby
        - ruby-dev
        - make
        - g++
        - diffutils
        - patch
        - libxml2-dev
        - libxslt1-dev
        - zlib1g-dev

    - name: Install NodeJS
      apt: pkg=nodejs state=latest

    - name: Install Compass
      gem: name=compass

    - name: Add Yarn APT key
      apt_key: url=https://dl.yarnpkg.com/debian/pubkey.gpg id=1646B01B86E50310

    - name: Add Yarn APT repository
      apt_repository: repo='deb http://dl.yarnpkg.com/debian/ stable main'

    - name: Install Yarn package manager
      apt: name=yarn update_cache=yes cache_valid_time=3600

    - name: Install nginx
      apt: pkg=nginx state=latest

    - name: Install Postfix
      apt: pkg=postfix state=latest

    - name: Install memcached
      apt: pkg=memcached state=latest

    - name: Start the memcached service
      service: name=memcached state=started enabled=yes

    - name: Install redis
      apt: pkg=redis-server state=latest

    - name: Start the redis service
      service: name=redis-server state=started enabled=yes

    - name: Restart the Postfix service
      service: name=postfix state=restarted enabled=yes

    - name: Install PHP, modules, and tools
      apt: pkg={{ item }} state=latest update_cache=yes cache_valid_time=3600
      with_items:
        - php7.0
        - php7.0-fpm
        - php7.0-cli
        - php7.0-memcached
        - php7.0-redis
        - php7.0-common
        - php7.0-intl
        - php7.0-curl
        - php7.0-dev
        - php7.0-gd
        - php7.0-xml
        - php7.0-json
        - php7.0-mbstring
        - php7.0-zip
        - phpunit

    - name: Restart php7.0-fpm
      become_user: 'root'
      action: service name=php7.0-fpm state=restarted enabled=yes

    - name: Install composer globally
      shell:  curl -sS https://getcomposer.org/installer | /usr/bin/php && sudo /bin/mv -f composer.phar {{ composer_path }} creates={{ composer_path }}
      args:
        warn: False

    - name: Remove the nginx example configuration files
      file:
        path: /etc/nginx/{{ item }}
        state: absent
      with_items:
        - sites-available/default
        - sites-enabled/default
        - conf.d/default.conf
        - conf.d/example_ssl.conf

    - name: Create directory for ssl
      when: create_ssl|default(True)
      become_user: 'root'
      file:
        path: /etc/nginx/ssl/
        owner: root
        group: root
        state: directory
        mode: 0775
        recurse: yes

    - name: create self-signed SSL cert
      when: create_ssl|default(True)
      become_user: 'root'
      command: openssl req -new -nodes -x509 -subj "/C=US/ST=Minnesota/L=Minneapolis/O=ST/CN={{ cert_name }}" -days 3650 -keyout /etc/nginx/ssl/server.key -out /etc/nginx/ssl/server.crt -extensions v3_ca creates=/etc/nginx/ssl/server.crt

    - name: Place nginx site config
      template:
        src: nginx-vhost.j2
        dest: /etc/nginx/sites-available/{{ server_name }}

    - name: Create the links to enable site configurations
      file: path=/etc/nginx/sites-enabled/{{ server_name }} state=link src=/etc/nginx/sites-available/{{ server_name }}

    - name: Restart nginx
      become_user: 'root'
      action: service name=nginx state=restarted enabled=yes
